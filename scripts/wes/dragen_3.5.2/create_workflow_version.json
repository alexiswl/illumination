{
  "Version": "four",
  "Definition": {
    "StartAt": "Somatic_TN_Phase",
    "States": {
      "Somatic_TN_Phase": {
        "Type": "LaunchTask",
        "ResultPath": "$.Somatic_TN_Phase",
        "Connection": "Stratus",
        "Comment": "",
        "TaskRun": {
          "name": "Somatic_TN_Phase",
          "description": "WES DRAGEN TN via S3",
          "execution": {
            "image": {
              "name": "699120554104.dkr.ecr.us-east-1.amazonaws.com/public/dragen",
              "tag": "3.5.2"
            },
            "command": "bash",
            "args": [
              "-c",
              "df -h; /opt/edico/bin/dragen --partial-reconfig DNA-MAPPER --ignore-version-check true; mkdir -p /ephemeral/ref; tar -C /ephemeral/ref -xvf /mount/index/hg19/hg19-cnv-anchored.v7.tar; /opt/edico/bin/dragen --lic-instance-id-location /opt/instance-identity -f -r /ephemeral/ref --tumor-fastq1 {{args.tumor1}} --tumor-fastq2 {{args.tumor2}} -1 {{args.normal1}} -2 {{args.normal2}} --RGID {{args.normal_name}} --RGSM {{args.normal_name}} --RGID-tumor {{args.tumor_name}} --RGSM-tumor {{args.tumor_name}} --enable-variant-caller true --output-directory /output/test --output-file-prefix somatic --vc-min-tumor-read-qual {{args.MAPQ}} --vc-tlod-filter-threshold {{args.TLOD}} --vc-enable-clustered-events-filter {{args.clustered_events_filter}} --vc-enable-triallelic-filter {{args.triallelic_filter}}"
            ],
            "inputs": [
              {
                "Path": "/mount/index/hg19/hg19-cnv-anchored.v7.tar",
                "Url": "https://use1-prd-seq-hub-appdata.s3.amazonaws.com/Edico_v5/hg19-cnv-anchored.v7.tar"
              }
            ],
            "outputs": [
              {
                "path": "/output/test",
                "url": "gds://{{args.gds_volume_name}}/vcf/somatic/{{args.batch}}"
              },
              {
                "path": "/var/log/tessystemlogs",
                "url": "gds://{{args.gds_volume_name}}/dragenlogs/alignment/somatic/{{args.batch}}"
              }
            ],
            "Environment": {
              "resources": {
                "Type": "fpga",
                "Size": "small"
              }
            }
          }
        },
        "Next": "Somatic_TN_Phase_Poll"
      },
      "Somatic_TN_Phase_Poll": {
        "Type": "CallApiAndPoll",
        "ResultPath": "$.Somatic_TN_Phase_Poll",
        "Comment": "Wait for DRAGEN somatic calling and VCF generation",
        "Method": "GET",
        "Connection": "Stratus",
        "Url": "/v1/tasks/runs/{{$.Somatic_TN_Phase.TaskRunId}}",
        "PollingJs": "function processResponse(input){var results={};if(input.ResponseMessage.IsSuccessStatusCode===false){results.Action=\"Fail\";results.ErrorCause=input.MappedError;return results;}var originalResults=JSON.parse(input.OriginalResults);if(originalResults.status===\"Pending\"||originalResults.status===\"Running\"){results.Action=\"Poll\";results.NextPollingIntervalInSeconds=300;}else{results.Action=\"Succeed\";results.FinalResults={};}return results;}",
        "End": true
      }
    },
    "Connections": [
      {
        "Name": "Stratus",
        "Host": "https://aps2.platform.illumina.com",
        "Type": "IlluminaJwt"
      }
    ],
    "Arguments": [
      {
        "Name": "batch"
      }, 	
      {
        "Name": "tumor1"
      },
      {
        "Name": "tumor2"
      },
      {
        "Name": "normal1"
      },
      {
        "Name": "normal2"
      },
      {
        "Name": "gds_volume_name"
      },
      {
      	"Name": "tumor_name"
      },
      {
      	"Name": "normal_name"
      },
      {
        "Name": "MAPQ",
        "Value": "30"
      },
      {
        "Name": "TLOD",
        "Value": "6.5"
      },
      {
        "Name": "clustered_events_filter",
        "Value": "true"
      },
      {
        "Name": "triallelic_filter",
        "Value": "true"
      }
    ]
  }
}
